function write(e,t,i){var n=new Object;n.result=e,n.tips=t,i.end(""+JSON.stringify(n))}function writeJsonp(e,t,i){var n=new Object;n.result=e,n.tips=t,i.writeHead(200,{"Content-Type":"text/html;charset:utf-8"}),i.end(""+n.tips)}function callback(e,t,i){i.end("<script>parent.callback('"+t+"',"+e+")</script>")}var http=require("http"),md5=require("../util/Md5"),nodegrass=require("nodegrass"),httpRequest=require("../util/httpRequest"),mysql=require("mysql"),log4js=require("log4js"),connection=mysql.createConnection({host:"203.195.150.220",user:"syjk",password:"syjk2015",database:"db_blue",port:3306}),os=require("os"),ccap=require("ccap")(),date=new Date;log4js.configure({appenders:[{type:"console"},{type:"file",filename:"public/logs/"+date.getFullYear()+"-"+date.getMonth()+"-"+date.getDate()+".log",maxLogSize:1024,backups:4,category:"normal"}],replaceConsole:!0});var logger=log4js.getLogger("normal");exports.loginAction=function(e,t){var i=e.query.user_name,n=e.query.password,r=e.query.rand,a="",s=e.session,c=!1;if(void 0==i||0==i.trim().length)return a="用户名为空！",c=!1,void write(c,a,t);if(void 0==n||0==n.trim().length)return a="密码不能为空",c=!1,void write(c,a,t);if(n=md5.hex_md5(n),void 0==r||0==r.trim().length)return a="验证码不能为空!",c=!1,void write(c,a,t);var o=s.code+"";if(void 0==r||r.toLowerCase()!=o.toLowerCase())return a="验证码不正确!",c=!1,void write(c,a,t);var l="select tl.username,tl.password,tu.* from tb_login tl LEFT JOIN tb_userinfo as tu on tl.id=tu.id where username='"+i+"'";connection.query(l,function(e,i,r){return e?(a="数据库加载失败!",c=!1,void write(c,a,t)):0==i.length?(a="没有该账号！",c=!1,void write(c,a,t)):n!=i[0].password?(a="密码不正确！",c=!1,void write(c,a,t)):(a="登陆成功！",c=!0,s.id=i[0].id,s.username=i[0].username,s.real_name=i[0].real_name,s.sex=i[0].sex,s.email=i[0].email,s.birth_place=i[0].birth_place,s.live_place=i[0].live_place,s.introduce=i[0].introduce,write(c,a,t),void 0)})},exports.logoutAction=function(e,t){e.session.destroy();var i="注销成功！",n=!0;write(n,i,t)},exports.homeAction=function(e,t){httpRequest.getClientIp(e).replace("::ffff:","");connection.query("select COUNT(*) as visit_count from tb_visit",function(i,n,r){var a=n[0].visit_count,s="select ta.*,tat.type_name,count(DISTINCT tac.comment_id) as comment_count,count(DISTINCT tas.scan_id) as scan_count from tb_article ta LEFT JOIN tb_articel_comment as tac on tac.article_id=ta.article_id LEFT JOIN tb_article_scan as tas  on tas.article_id=ta.article_id LEFT JOIN tb_article_type as tat  on tat.type_id=ta.type_id    GROUP  BY ta.article_id  ORDER BY  tat.type_id,  ta.create_time DESC";connection.query("select * from tb_userinfo",function(i,n,r){var c=n[0];connection.query(s,function(i,n,r){for(var s=new Array,o=-1,l=0;l<n.length;l++)if(o!=n[l].type_id){o=n[l].type_id;var u=new Object;u.type_id=o,u.type_name=n[l].type_name,u.type_desc=n[l].type_desc,s.push(u)}for(var u=new Object,d=0;d<s.length;d++){for(var _=new Array,l=0;l<n.length;l++)if(s[d].type_id==n[l].type_id){var f=new Object;f.article_id=n[l].article_id,f.article_id=n[l].article_id,f.title=n[l].title,f.content=n[l].content,f.author=n[l].author,f.create_time=n[l].create_time,f.scan_count=n[l].scan_count,f.comment_count=n[l].comment_count,_.push(f)}s[d].articleList=_}t.render("index",{session:void 0==e.session.username?"null":e.session,visit_count:a,userinfo:c,title:"",typeList:s})})})})},exports.blogAction=function(e,t){var i=e.query.type_id;i=void 0!=i?"where ta.type_id="+i:"";var n="select ta.*,tat.type_name,count(DISTINCT tac.comment_id) as comment_count,count(DISTINCT tas.scan_id) as scan_count from tb_article ta LEFT JOIN tb_articel_comment as tac on tac.article_id=ta.article_id LEFT JOIN tb_article_scan as tas  on tas.article_id=ta.article_id LEFT JOIN tb_article_type as tat  on tat.type_id=ta.type_id  "+i+"   GROUP  BY ta.article_id  ORDER BY  tat.type_id,  ta.create_time DESC ";connection.query(n,function(i,n,r){var a=n,s="select article_type.* ,count(DISTINCT article.article_id) as article_count from tb_article_type article_type LEFT JOIN tb_article as article on article.type_id=article_type.type_id GROUP BY article_type.type_id";connection.query(s,function(i,n,r){var s=n,c="SELECT * from tb_articel_comment ORDER BY comment_time desc limit 4";connection.query(c,function(i,n,r){var c=n;t.render("blog",{session:void 0==e.session.username?"null":e.session,title:"",article_list:a,type_list:s,comment_list:c})})})})},exports.addNewArticleTypeAction=function(e,t){var i=e.query.type_name,n=e.query.type_desc,r="",a=!1;e.session;if(void 0==i||0==i.trim().length)return r="分类名不能为空！",a=!1,void write(a,r,t);if(void 0==n||0==n.trim().length)return r="分类描述不能为空",a=!1,void write(a,r,t);var c="select * from tb_article_type where type_name='"+i+"'";connection.query(c,function(e,s,c){if(e)return r="数据库加载失败!",a=!1,void write(a,r,t);if(s.length>0)return r="该分类已存在",a=!1,void write(a,r,t);var o="INSERT INTO tb_article_type (type_name,type_desc) VALUES('"+i+"','"+n+"')";connection.query(o,function(e,i,n){r="创建成功!",a=!0,write(a,r,t)})})},exports.renameArticleTypeAction=function(e,t){var i=e.query.type_name,n=e.query.type_id,r="",a=!1;e.session;if(void 0==i||0==i.trim().length)return r="分类名不能为空！",a=!1,void write(a,r,t);if(void 0==n||0==n.trim().length)return r="未指定分类",a=!1,void write(a,r,t);var c="update tb_article_type set type_name='"+i+"' where type_id="+n;connection.query(c,function(e,i,n){r="修改成功!",a=!0,write(a,r,t)})},exports.adelArticleTypeAction=function(e,t){var i=e.query.type_id,n="",r=!1;e.session;if(void 0==i||0==i.trim().length)return n="未指定分类",r=!1,void write(r,n,t);var s="delete from tb_article_type  where type_id="+i;connection.query(s,function(e,i,a){n="删除成功!",r=!0,write(r,n,t)})},exports.articleTypeAction=function(e,t){var i="select * from tb_article_type";connection.query(i,function(i,n,r){t.render("newArticle",{session:void 0==e.session.username?"null":e.session,title:"",typeList:n})})},exports.articleDetailAction=function(e,t){logger.debug("articleDetailAction");var i=e.query.article_id,r=(e.query.type,"select ta.*,tat.type_name,count(DISTINCT tac.comment_id) as comment_count,count(DISTINCT tas.scan_id) as scan_count from tb_article ta LEFT JOIN tb_articel_comment as tac on tac.article_id=ta.article_id LEFT JOIN tb_article_scan as tas  on tas.article_id=ta.article_id LEFT JOIN tb_article_type as tat  on tat.type_id=ta.type_id where ta.article_id="+i),a="SELECT * from tb_articel_comment where article_id="+i+" ORDER BY comment_time desc";connection.query(r,function(i,n,r){var s=n;console.log("article:"+s),connection.query(a,function(i,n,r){var a=n;t.render("articleDetail",{session:void 0==e.session.username?"null":e.session,title:"",article:s,comment_list:a})})})},exports.createNewArticleAction=function(e,t){var i=e.body.type_id,n=e.body.title,r=e.body.content,a=e.body.author,s="",c=!1;e.session;if(void 0==i||0==i.trim().length)return s="请传入文章分类！",c=!1,void callback(c,s,t);if(void 0==n||0==n.trim().length)return s="标题不嫩为空！",c=!1,void callback(c,s,t);if(void 0==r||0==r.trim().length)return s="文章内容不能为空！",c=!1,void callback(c,s,t);var l="select * from tb_article where title='"+n+"'";connection.query(l,function(e,o,l){if(e)return s="数据库加载失败!",c=!1,void callback(c,s,t);if(o.length>0)return s="文章标题已存在！",c=!1,void callback(c,s,t);var u="INSERT INTO tb_article (type_id,title,content,author,create_time) VALUES('"+i+"','"+n+"','"+r+"','"+a+"',now())";connection.query(u,function(e,i,n){s="创建成功!",c=!0,callback(c,s,t)})})},exports.commentArticleAction=function(e,t){var i=e.body.article_id,n=e.body.user,r=e.body.comment,a=e.body.code,s="",c=!1,o=e.session;if(void 0==i||0==i.trim().length)return s="未指定文章！",c=!1,void callback(c,s,t);if(void 0==n||0==n.trim().length)return s="请填写用户名！",c=!1,void callback(c,s,t);if(void 0==r||0==r.trim().length)return s="评论内容不能为空！",c=!1,void callback(c,s,t);if(void 0==a||0==a.trim().length)return s="验证码不能为空!",c=!1,void callback(c,s,t);var l=o.code+"";if(void 0==a||a.toLowerCase()!=l.toLowerCase())return s="验证码不正确!",c=!1,void callback(c,s,t);var u="INSERT into tb_articel_comment(article_id,user,comment,comment_time)  VALUES('"+i+"','"+n+"','"+r+"',now())";connection.query(u,function(e,i,n){s="发表成功!",c=!0,callback(c,s,t)})},exports.leaveMsgAction=function(e,t){var i=e.query.user,n=e.query.content,r="",a=!1;e.session;if(void 0==i||0==i.trim().length)return r="请填写用户名！",a=!1,void write(a,r,t);if(void 0==n||0==n.trim().length)return r="内容不能为空！",a=!1,void write(a,r,t);var c="INSERT into tb_leave_msg(user,content,create_time)  VALUES('"+i+"','"+n+"',now())";connection.query(c,function(e,i,n){r="留言成功!",a=!0,write(a,r,t)})},exports.addImageTypeAction=function(e,t){var i=e.query.type_name,n=e.query.type_desc,r="",a=!1;e.session;if(void 0==i||0==i.trim().length)return r="相册名称不能为空！",a=!1,void write(a,r,t);if(void 0==n||0==n.trim().length)return r="相册描述不能为空！",a=!1,void write(a,r,t);var c="INSERT into tb_img_type(type_name,type_desc,create_time) VALUES('"+i+"','"+n+"',NOW())";connection.query(c,function(e,i,n){r="创建成功!",a=!0,write(a,r,t)})},exports.editImageTypeActin=function(e,t){var i=e.query.type_name,n=e.query.image_type_id,r=e.query.type_desc,a="",s=!1;e.session;if(void 0==n||0==n.trim().length)return a="请指定要修改的相册",s=!1,void write(s,a,t);if(void 0==i||0==i.trim().length)return a="相册名称不能为空！",s=!1,void write(s,a,t);if(void 0==r||0==r.trim().length)return a="相册描述不能为空！",s=!1,void write(s,a,t);var o="UPDATE tb_img_type set type_name='"+i+"' ,type_desc='"+r+"',create_time=NOW() where image_type_id="+n;connection.query(o,function(e,i,n){a="修改成功!",s=!0,write(s,a,t)})},exports.deleteImageTypeActin=function(e,t){var i=e.query.image_type_id,n="",r=!1;e.session;if(void 0==i||0==i.trim().length)return n="请指定要删除的相册",r=!1,void write(r,n,t);var s="delete img,type from tb_img_type type LEFT JOIN tb_img as img on img.image_type_id=type.image_type_id where type.image_type_id="+i;connection.query(s,function(e,i,a){n="删除成功!",r=!0,write(r,n,t)})},exports.editImageActin=function(e,t){var i=e.query.img_id,n=e.query.img_desc,r="",a=!1;e.session;if(void 0==i||0==i.trim().length)return r="请指定要修改的相片",a=!1,void write(a,r,t);if(void 0==n||0==n.trim().length)return r="相片描述不能为空！",a=!1,void write(a,r,t);var c="UPDATE tb_img set img_desc='"+n+"',create_time=NOW() where img_id="+i;connection.query(c,function(e,i,n){r="修改成功!",a=!0,write(a,r,t)})},exports.deleteImageActin=function(e,t){var i=e.query.img_id,n="",r=!1;e.session;if(void 0==i||0==i.trim().length)return n="请指定要删除的相片！",r=!1,void write(r,n,t);var s="delete  from  tb_img  where img_id="+i;connection.query(s,function(e,i,a){n="删除成功!",r=!0,write(r,n,t)})},exports.albumListAction=function(e,t){var i="select type.*,COUNT(img.img_id) as img_count,IFNULL(img.img_url,'images/album_no_pic.gif') as cover from tb_img_type type LEFT JOIN tb_img as img on type.image_type_id=img.image_type_id GROUP BY type.image_type_id";connection.query(i,function(i,n,r){t.render("albumList",{session:void 0==e.session.username?"null":e.session,albumLis:n,title:""})})},exports.imgUploadAction=function(e,t){var i="select type.*,COUNT(img.img_id) as img_count,IFNULL(img.img_url,'images/album_no_pic.gif') as cover from tb_img_type type LEFT JOIN tb_img as img on type.image_type_id=img.image_type_id GROUP BY type.image_type_id";connection.query(i,function(i,n,r){t.render("imgUpload",{session:void 0==e.session.username?"null":e.session,albumLis:n,title:""})})},exports.sumbitImgAction=function(e,t){var i=e.query.img_desc,n=e.query.image_type_id,r=e.query.img_url,a="",s=!1;e.session;if(void 0==n||0==n.trim().length)return a="请指定要上传的相册",s=!1,void write(s,a,t);if(void 0==i||0==i.trim().length)return a="相片描述不能为空！",s=!1,void write(s,a,t);if(void 0==r||0==r.trim().length)return a="相片路径不能为空！",s=!1,void write(s,a,t);for(var o="",l=r.split(","),u=i.split(","),d=0;d<l.length;d++)void 0!=l[d]&&""!=l[d]&&(o=o+"("+n+", '"+u[d]+"', '"+l[d]+"', NOW()),");if(""==o)a="参数出错!",s=!1,write(s,a,t);else{o=o.substring(0,o.length-1);var _="INSERT into tb_img(image_type_id,img_desc,img_url,create_time) VALUES "+o;connection.query(_,function(e,i,n){a="上传成功!",s=!0,write(s,a,t)})}},exports.profileAction=function(e,t){var i="select * from tb_userinfo";connection.query("select * from tb_article ORDER BY create_time LIMIT 10",function(n,r,a){var s=r;connection.query("select * from tb_leave_msg",function(n,r,a){var c=r;connection.query(i,function(i,n,r){var a=n[0];t.render("profile",{session:void 0==e.session.username?"null":e.session,userinfo:a,leavList:c,articleList:s,title:""})})})})},exports.msgBoardAction=function(e,t){connection.query("select * from tb_leave_msg",function(i,n,r){var a=n;t.render("msgBoard",{session:void 0==e.session.username?"null":e.session,leavList:a,title:""})})},exports.albumDetailAction=function(e,t){var i=e.query.image_type_id,n="select * from tb_img where image_type_id="+i;connection.query(n,function(i,n,r){t.render("albumDetail",{session:void 0==e.session.username?"null":e.session,imgList:n,title:""})})},exports.articleTypeEditAction=function(e,t){var i="select article_type.* from tb_article_type article_type";connection.query(i,function(i,n,r){t.render("articleTypeEdit",{session:void 0==e.session.username?"null":e.session,typeList:n,title:""})})},exports.randCode=function(e,t){if("/favicon.ico"==e.url)return t.end("");var i=ccap.get(),n=i[0],r=i[1];e.session.code=n;var a=httpRequest.getClientIp(e).replace("::ffff:","");logger.debug("code:"+n),logger.debug("ip:"+a),t.end(r)},exports.visitAction=function(req,res){var tips="",result=!1,type=req.query.type,article_id=req.query.article_id,ip=httpRequest.getClientIp(req).replace("::ffff:","");nodegrass.get("http://ip.taobao.com//service/getIpInfo.php?ip="+ip,function(data,status,headers){var data=eval("("+data+")");if(void 0==type)return tips="var jsonp='参数出错'",result=!1,void writeJsonp(result,tips,res);if(0!=data.code)return tips="var jsonp='参数出错'",result=!1,void writeJsonp(result,tips,res);var sql="";if(0==type)sql="INSERT into tb_visit(ip,country,area,province,city,ip_type,visit_time) VALUE('"+ip+"','"+unescape(data.data.country)+"','"+unescape(data.data.area)+"','"+unescape(data.data.region)+"','"+unescape(data.data.city)+"','"+unescape(data.data.isp)+"',NOW())";else{if(1!=type||void 0==article_id)return tips="var jsonp='参数出错！'",result=!1,void writeJsonp(result,tips,res);sql="INSERT INTO tb_article_scan(article_id,ip,country,area,province,city,ip_type,scan_time) VALUES ("+article_id+",'"+ip+"','"+unescape(data.data.country)+"','"+unescape(data.data.area)+"','"+unescape(data.data.region)+"','"+unescape(data.data.city)+"','"+unescape(data.data.isp)+"',NOW())"}logger.debug("sql:"+sql),connection.query(sql,function(e,t,i){tips="var jsonp='少年你终于发现了！'",result=!0,writeJsonp(result,tips,res)})},"gbk").on("error",function(e){tips="var jsonp='网络慢'",result=!1,writeJsonp(result,tips,res)})};