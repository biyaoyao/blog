var path=require("path"),fs=require("fs"),os=require("os"),hrobj=require("../build/Release/hcaptha.node"),dirObj=require("./dir.js"),timer=require("./timer.js"),gen_func=require("./gen.js"),ins_count=0,img_path=path.join(__dirname,"../","/cap_img"),pid=process.pid,isjpeg="linux"==os.platform()?1:0,fname=isjpeg?".jpeg":".bmp",CAP=function(t){return this instanceof arguments.callee?(this.filename=img_path+"/captcha_"+ins_count+"_"+pid+"_"+Date.now()+"_{$number}"+fname,this.width=100,this.height=30,this.offset=20,this.quality=50,this._text_len=4,this.generate=null,this.fontsize=28,this.is_first=!0,this._cache_num=20,this.buf=[],this.text_buf=[],this._init(t),this._create=this.generate?this._custom_create:this._default_create,this._create(),this.is_first=!1,this.setTimeout=timer.timer,this.clearTimeout=timer.clearTimeout,void(this.timerIsRunning=timer.getIsRunning)):new arguments.callee(t)};CAP.prototype._init=function(t){if(!(arguments.length<1)){if("object"==typeof arguments[0]){var e=arguments[0];return this.width=e.width||this.width,this.height=e.height||this.height,this.offset=e.offset||this.offset,this.quality=e.quality||this.quality,this.generate=e.generate||null,void(this.fontsize=e.fontsize||this.fontsize)}return this.width=arguments[0]||this.width,this.height=arguments[1]||this.height,this.offset=arguments[2]||this.offset,this._get_count=0,this}},CAP.prototype._default_generate=gen_func,CAP.prototype._call_create=function(t,e,i){var r=this,s=r.filename.replace("{$number}",i);hrobj.create(t,s,e,r.width,r.height,r.offset,r.quality,isjpeg,r.fontsize);try{var h=fs.readFileSync(s)}catch(a){console.log("readsync file error")}return r.buf[i]=h,r.text_buf[i]=t,this},CAP.prototype._default_create=function(){for(var t=0;t<this._cache_num;t++)this._call_create(this._default_generate(),this._text_len,t);return this},CAP.prototype._custom_create=function(){for(var t=0;t<this._cache_num;t++){var e=this.generate();this._call_create(e,e.length,t)}return this},CAP.prototype._timer=function(){this._get_count++,this._create()},CAP.prototype.get=function(){var t=Math.floor(Math.random()*this._cache_num);return[this.text_buf[t],this.buf[t]]},module.exports=function(t){var e=CAP(t);return ins_count++,timer.reg_ary.push(e),e},dirObj.dir(),dirObj.setSchedule(),timer.timer();