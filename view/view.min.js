var query=require("../util/mysql.js"),nodegrass=require("nodegrass"),httpRequest=require("../util/httpRequest"),logger=require("../util/log4js.js"),cache=require("memory-cache");exports.index=function(e,t){var i=cache.get("index");if(logger.debug("index:"+i),null!=i&&i.session==(void 0==e.session.username?"null":e.session))return i.visit_count++,void t.render("index",i);httpRequest.getClientIp(e).replace("::ffff:","");query("select COUNT(*) as visit_count from tb_visit",function(i,s,n){var r=null==s?new Object:s[0].visit_count,a="select ta.*,tat.type_name,count(DISTINCT tac.comment_id) as comment_count,count(DISTINCT tas.scan_id) as scan_count from tb_article ta LEFT JOIN tb_articel_comment as tac on tac.article_id=ta.article_id LEFT JOIN tb_article_scan as tas  on tas.article_id=ta.article_id LEFT JOIN tb_article_type as tat  on tat.type_id=ta.type_id    GROUP  BY ta.article_id  ORDER BY  tat.type_id,  ta.create_time DESC";query("select * from tb_userinfo",function(i,s,n){var l=null==s?new Object:s[0];query(a,function(i,s,n){for(var a=new Array,o=-1,u=0;u<s.length;u++)if(o!=s[u].type_id){o=s[u].type_id;var c=new Object;c.type_id=o,c.type_name=s[u].type_name,c.type_desc=s[u].type_desc,a.push(c)}for(var c=new Object,d=0;d<a.length;d++){for(var _=new Array,u=0;null!=s&&u<s.length;u++)if(a[d].type_id==s[u].type_id){var m=new Object;m.article_id=s[u].article_id,m.article_id=s[u].article_id,m.title=s[u].title,m.content=s[u].content,m.author=s[u].author,m.create_time=s[u].create_time,m.scan_count=s[u].scan_count,m.comment_count=s[u].comment_count,_.push(m)}a[d].articleList=_}cache.put("index",{session:void 0==e.session.username?"null":e.session,visit_count:r,userinfo:l,title:"",typeList:a},36e5),t.render("index",{session:void 0==e.session.username?"null":e.session,visit_count:r,userinfo:l,title:"",typeList:a})})})})},exports.blog=function(e,t){var i=cache.get("blog"),s=e.query.type_id;if(logger.debug("blog:"+i),null!=i&&(i.type_id==s||void 0==s)&&i.session==(void 0==e.session.username?"null":e.session))return void t.render("blog",i);s=void 0!=s?"where ta.type_id="+s:"";var n="select ta.*,tat.type_name,count(DISTINCT tac.comment_id) as comment_count,count(DISTINCT tas.scan_id) as scan_count from tb_article ta LEFT JOIN tb_articel_comment as tac on tac.article_id=ta.article_id LEFT JOIN tb_article_scan as tas  on tas.article_id=ta.article_id LEFT JOIN tb_article_type as tat  on tat.type_id=ta.type_id  "+s+"   GROUP  BY ta.article_id  ORDER BY  tat.type_id,  ta.create_time DESC ";query(n,function(i,s,n){var r=s,a="select article_type.* ,count(DISTINCT article.article_id) as article_count from tb_article_type article_type LEFT JOIN tb_article as article on article.type_id=article_type.type_id GROUP BY article_type.type_id";query(a,function(i,s,n){var a=s,l="SELECT * from tb_articel_comment ORDER BY comment_time desc limit 4";query(l,function(i,s,n){var l=s;cache.put("blog",{session:void 0==e.session.username?"null":e.session,title:"",article_list:r,type_list:a,comment_list:l,type_id:e.query.type_id},36e5),t.render("blog",{session:void 0==e.session.username?"null":e.session,title:"",article_list:r,type_list:a,comment_list:l})})})})},exports.albumList=function(e,t){var i=cache.get("albumList");if(logger.debug("albumList:"+i),null!=i&&i.session==(void 0==e.session.username?"null":e.session))return void t.render("albumList",i);var s="select type.*,COUNT(img.img_id) as img_count,IFNULL(img.img_url,'images/album_no_pic.gif') as cover from tb_img_type type LEFT JOIN tb_img as img on type.image_type_id=img.image_type_id GROUP BY type.image_type_id";query(s,function(i,s,n){cache.put("albumList",{session:void 0==e.session.username?"null":e.session,albumLis:s,title:""},36e5),t.render("albumList",{session:void 0==e.session.username?"null":e.session,albumLis:s,title:""})})},exports.albumDetail=function(e,t){var i=e.query.image_type_id,s=cache.get("albumDetail");if(logger.debug("albumDetail:"+s),null!=s&&s.image_type_i==i&&s.session==(void 0==e.session.username?"null":e.session))return void t.render("albumDetail",s);var n="select * from tb_img where image_type_id="+i;query(n,function(s,n,r){cache.put("albumDetail",{session:void 0==e.session.username?"null":e.session,imgList:n,image_type_id:i,title:""},36e5),t.render("albumDetail",{session:void 0==e.session.username?"null":e.session,imgList:n,title:""})})},exports.imgUpload=function(e,t){var i=cache.get("imgUpload");if(logger.debug("imgUpload:"+i),null!=i&&i.session==(void 0==e.session.username?"null":e.session))return void t.render("imgUpload",i);var s="select type.*,COUNT(img.img_id) as img_count,IFNULL(img.img_url,'images/album_no_pic.gif') as cover from tb_img_type type LEFT JOIN tb_img as img on type.image_type_id=img.image_type_id GROUP BY type.image_type_id";query(s,function(i,s,n){cache.put("imgUpload",{session:void 0==e.session.username?"null":e.session,albumLis:s,title:""},36e5),t.render("imgUpload",{session:void 0==e.session.username?"null":e.session,albumLis:s,title:""})})},exports.profile=function(e,t){var i=cache.get("profile");if(logger.debug("profile:"+i),null!=i&&i.session==(void 0==e.session.username?"null":e.session))return void t.render("profile",i);var s="select * from tb_userinfo";query("select * from tb_article ORDER BY create_time LIMIT 10",function(i,n,r){var a=n;query("select * from tb_leave_msg",function(i,n,r){var l=n;query(s,function(i,s,n){var r=s[0];cache.put("profile",{session:void 0==e.session.username?"null":e.session,userinfo:r,leavList:l,articleList:a,title:""},36e5),t.render("profile",{session:void 0==e.session.username?"null":e.session,userinfo:r,leavList:l,articleList:a,title:""})})})})},exports.msgBoard=function(e,t){var i=cache.get("msgBoard");return logger.debug("msgBoard:"+i),null!=i&&i.session==(void 0==e.session.username?"null":e.session)?void t.render("msgBoard",i):void query("select * from tb_leave_msg",function(i,s,n){var r=s;cache.put("msgBoard",{session:void 0==e.session.username?"null":e.session,leavList:r,title:""},36e5),t.render("msgBoard",{session:void 0==e.session.username?"null":e.session,leavList:r,title:""})})},exports.manager=function(e,t){t.render("manager",{session:null==e.session.username?"null":e.session,title:""})},exports.login=function(e,t){t.render("login",{session:null==e.session.username?"null":e.session,title:""})},exports.newArticle=function(e,t){var i=cache.get("newArticle");if(logger.debug("newArticle:"+i),null!=i&&i.session==(void 0==e.session.username?"null":e.session))return void t.render("newArticle",i);var s="select * from tb_article_type";query(s,function(i,s,n){cache.put("newArticle",{session:void 0==e.session.username?"null":e.session,title:"",typeList:s},36e5),t.render("newArticle",{session:void 0==e.session.username?"null":e.session,title:"",typeList:s})})},exports.articleTypeEdit=function(e,t){var i=cache.get("articleTypeEdit");if(logger.debug("articleTypeEdit:"+i),null!=i&&i.session==(void 0==e.session.username?"null":e.session))return void t.render("articleTypeEdit",i);var s="select article_type.* from tb_article_type article_type";query(s,function(i,s,n){cache.put("articleTypeEdit",{session:void 0==e.session.username?"null":e.session,typeList:s,title:""},36e5),t.render("articleTypeEdit",{session:void 0==e.session.username?"null":e.session,typeList:s,title:""})})},exports.articleDetail=function(e,t){var i=cache.get("articleDetail"),s=e.query.article_id;if(logger.debug("article_id:"+s),null!=i&&s==i.article_id&&i.session==(void 0==e.session.username?"null":e.session))return void t.render("articleDetail",i);var r=(e.query.type,"select ta.*,tat.type_name,count(DISTINCT tac.comment_id) as comment_count,count(DISTINCT tas.scan_id) as scan_count from tb_article ta LEFT JOIN tb_articel_comment as tac on tac.article_id=ta.article_id LEFT JOIN tb_article_scan as tas  on tas.article_id=ta.article_id LEFT JOIN tb_article_type as tat  on tat.type_id=ta.type_id where ta.article_id="+s),a="SELECT * from tb_articel_comment where article_id="+s+" ORDER BY comment_time desc";query(r,function(i,n,r){var l=n;logger.debug("article:"+l),query(a,function(i,n,r){var a=n;cache.put("articleDetail",{session:void 0==e.session.username?"null":e.session,title:"",article:l,article_id:s,comment_list:a},36e5),t.render("articleDetail",{session:void 0==e.session.username?"null":e.session,title:"",article:l,comment_list:a})})})};